<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="幻辰"><title>Kerberos-OpenLDAP配置及坑点 · 幻辰</title><meta name="description" content="Kerberos-OpenLdap配置及坑点OpenLDAP0x00 LDAP &amp;amp;OpenLDAP
Lightweight Directory Access Protocol，轻量级目录访问协议。OpenLDAP， LDAP的自由和开源的实现。

LDAP是一个基于TCP/IP的目录访问协议"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.jpg" style="width:0px;"><h3 title=""><a href="/">幻辰</a></h3><div class="description"><p>双子座中二少年 腿部挂件</p></div></div></div><ul class="social-links"><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/2981904955"><i class="fa fa-weibo"></i></a></li><li><a href="https://github.com/HtHuanChen"><i class="fa fa-github"></i></a></li></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="http://image.shuoman.com/file/userfiles/images/auto68/2017031614472066932.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Kerberos-OpenLDAP配置及坑点</a></h3></div><div class="post-content"><h1 id="Kerberos-OpenLdap配置及坑点"><a href="#Kerberos-OpenLdap配置及坑点" class="headerlink" title="Kerberos-OpenLdap配置及坑点"></a>Kerberos-OpenLdap配置及坑点</h1><h2 id="OpenLDAP"><a href="#OpenLDAP" class="headerlink" title="OpenLDAP"></a>OpenLDAP</h2><h3 id="0x00-LDAP-amp-OpenLDAP"><a href="#0x00-LDAP-amp-OpenLDAP" class="headerlink" title="0x00 LDAP &amp;OpenLDAP"></a>0x00 LDAP &amp;OpenLDAP</h3><blockquote>
<p>Lightweight Directory Access Protocol，轻量级目录访问协议。<br>OpenLDAP， LDAP的自由和开源的实现。</p>
</blockquote>
<p>LDAP是一个基于TCP/IP的目录访问协议，并专门针对读取、浏览、和搜索操作进行了特定的优化。目录作为一种特殊的数据库，与关系型数据库相比，LDAP更适用于经常被查询，但不需要经常更新的场景，例如DNS协议便是一种被广泛适用的目录服务。</p>
<hr>
<h3 id="0x01-OpenLDAP的安装及配置"><a href="#0x01-OpenLDAP的安装及配置" class="headerlink" title="0x01 OpenLDAP的安装及配置"></a>0x01 OpenLDAP的安装及配置</h3><h4 id="OpenLDAP基础配置"><a href="#OpenLDAP基础配置" class="headerlink" title="OpenLDAP基础配置"></a>OpenLDAP基础配置</h4><h5 id="安装相关程序包并设置默认配置文件，并启动服务"><a href="#安装相关程序包并设置默认配置文件，并启动服务" class="headerlink" title="安装相关程序包并设置默认配置文件，并启动服务"></a>安装相关程序包并设置默认配置文件，并启动服务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ yum install -y openldap-servers openldap-clients</div><div class="line">$ cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</div><div class="line">$ chown ldap. /var/lib/ldap/DB_CONFIG</div><div class="line">$ systemctl start slapd</div></pre></td></tr></table></figure>
<h5 id="生成并设置管理员密码"><a href="#生成并设置管理员密码" class="headerlink" title="生成并设置管理员密码"></a>生成并设置管理员密码</h5><p>使用<code>slappasswd</code>生成，记得使用强密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ slappasswd</div><div class="line">New password:123456</div><div class="line">Re-enter new password:123456</div><div class="line">&#123;SSHA&#125;d0R33elGDZvPxRwhxDb0KJqG5CisR3kT</div></pre></td></tr></table></figure>
<p>使用<code>ldapadd</code>添加配置文件，OpenLDAP2.4版本功能，动态更改配置文件，无需重启服务即可生效。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ vim chrootpw.ldif</div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;0&#125;config,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcRootPW</div><div class="line"><span class="attribute">olcRootPW</span>: &#123;SSHA&#125;d0R33elGDZvPxRwhxDb0KJqG5CisR3kT</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f chrootpw.ldif</div></pre></td></tr></table></figure>
<h5 id="导入基础Schema"><a href="#导入基础Schema" class="headerlink" title="导入基础Schema"></a>导入基础Schema</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/core.ldif</div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif</div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif</div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</div></pre></td></tr></table></figure>
<h5 id="配置LDAP顶级域-dc-example-dc-com-及其管理域"><a href="#配置LDAP顶级域-dc-example-dc-com-及其管理域" class="headerlink" title="配置LDAP顶级域(dc=example,dc=com)及其管理域"></a>配置LDAP顶级域(dc=example,dc=com)及其管理域</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ slappasswd</div><div class="line">New password:123456</div><div class="line">Re-enter new password:123456</div><div class="line">&#123;SSHA&#125;d0R33elGDZvPxRwhxDb0KJqG5CisR3kT</div></pre></td></tr></table></figure>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">$ vim chdomain.ldif</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;1&#125;monitor,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">replace</span>: olcAccess</div><div class="line"><span class="attribute">olcAccess</span>: &#123;0&#125;to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"</div><div class="line">  read by dn.base="cn=admin,dc=example,dc=com" read by * none</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">replace</span>: olcSuffix</div><div class="line"><span class="attribute">olcSuffix</span>: dc=example,dc=com</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">replace</span>: olcRootDN</div><div class="line"><span class="attribute">olcRootDN</span>: cn=admin,dc=example,dc=com</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcRootPW</div><div class="line"><span class="attribute">olcRootPW</span>: &#123;SSHA&#125;d0R33elGDZvPxRwhxDb0KJqG5CisR3kT</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcAccess</div><div class="line"><span class="attribute">olcAccess</span>: &#123;0&#125;to attrs=userPassword,shadowLastChange by</div><div class="line">  dn="cn=admin,dc=example,dc=com" write by anonymous auth by self write by * none</div><div class="line"><span class="attribute">olcAccess</span>: &#123;1&#125;to dn.base="" by * read</div><div class="line"><span class="attribute">olcAccess</span>: &#123;2&#125;to * by dn="cn=admin,dc=example,dc=com" write by * read</div><div class="line"></div><div class="line">$ ldapmodify -Y EXTERNAL -H ldapi:/// -f chdomain.ldif</div></pre></td></tr></table></figure>
<h5 id="根据需求添加组织及角色"><a href="#根据需求添加组织及角色" class="headerlink" title="根据需求添加组织及角色"></a>根据需求添加组织及角色</h5><p>这里只添加了一个组织及一个拥有最高权限的管理员角色</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ vim basedomain.ldif</div><div class="line"><span class="attribute">dn</span>: dc=example,dc=com</div><div class="line"><span class="attribute">objectClass</span>: top</div><div class="line"><span class="attribute">objectClass</span>: dcObject</div><div class="line"><span class="attribute">objectclass</span>: organization</div><div class="line"><span class="attribute">o</span>: EXAMPLE.COM</div><div class="line"><span class="attribute">dc</span>: example</div><div class="line"></div><div class="line"><span class="attribute">dn</span>: cn=admin,dc=example,dc=com</div><div class="line"><span class="attribute">objectClass</span>: organizationalRole</div><div class="line"><span class="attribute">cn</span>: Admin</div><div class="line"></div><div class="line">$ ldapadd -x -D cn=admin,dc=example,dc=com -W -f basedomain.ldif</div></pre></td></tr></table></figure>
<h5 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h5><p>使用2的n次方表示各种等级的日志记录，可以通过相加的方式，设定多种等级的的日志记录；也可以通过使用多个关键字设置多种等级日志。</p>
<table>
<thead>
<tr>
<th style="text-align:right">level</th>
<th style="text-align:left">keyword</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">-1</td>
<td style="text-align:left">any</td>
<td style="text-align:left">记录全部debug信息</td>
</tr>
<tr>
<td style="text-align:right">0</td>
<td style="text-align:left">(0x1 )</td>
<td style="text-align:left">不记录debug信息</td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td style="text-align:left">(0x1 trace)</td>
<td style="text-align:left">记录函数调用</td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td style="text-align:left">(0x2 packets)</td>
<td style="text-align:left">记录包处理信息</td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td style="text-align:left">(0x4 args)</td>
<td style="text-align:left">丰富的debug信息</td>
</tr>
<tr>
<td style="text-align:right">8</td>
<td style="text-align:left">(0x8 conns)</td>
<td style="text-align:left">连接管理信息</td>
</tr>
<tr>
<td style="text-align:right">16</td>
<td style="text-align:left">(0x10 BER)</td>
<td style="text-align:left">打印包收发过程</td>
</tr>
<tr>
<td style="text-align:right">32</td>
<td style="text-align:left">(0x20 filter)</td>
<td style="text-align:left">搜索过滤处理过程</td>
</tr>
<tr>
<td style="text-align:right">64</td>
<td style="text-align:left">(0x40 config)</td>
<td style="text-align:left">配置文件处理过程</td>
</tr>
<tr>
<td style="text-align:right">128</td>
<td style="text-align:left">(0x80 ACL)</td>
<td style="text-align:left">访问控制列表处理过程</td>
</tr>
<tr>
<td style="text-align:right">256</td>
<td style="text-align:left">(0x100 stats)</td>
<td style="text-align:left">连接、操作及结果统计数据（默认）</td>
</tr>
<tr>
<td style="text-align:right">512</td>
<td style="text-align:left">(0x200 stats2)</td>
<td style="text-align:left">向客户端返回的结果的统计信息</td>
</tr>
<tr>
<td style="text-align:right">1024</td>
<td style="text-align:left">(0x400 shell)</td>
<td style="text-align:left">与shell通信信息</td>
</tr>
<tr>
<td style="text-align:right">2048</td>
<td style="text-align:left">(0x800 parse)</td>
<td style="text-align:left">数据库缓存处理信息</td>
</tr>
<tr>
<td style="text-align:right">16384</td>
<td style="text-align:left">(0x4000 sync)</td>
<td style="text-align:left">同步资源消耗信息</td>
</tr>
<tr>
<td style="text-align:right">32768</td>
<td style="text-align:left">(0x8000 none)</td>
<td style="text-align:left">不记录日志</td>
</tr>
</tbody>
</table>
<p><em>OpenLDAP</em> 的日志记录需要依靠<code>rsyslog</code>服务，需要在更改<em>OpenLDAP</em> 配置文件后配置并重启<code>rsyslog</code>服务。<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ vim log.ldif</div><div class="line"><span class="attribute">dn</span>: cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">replace</span>: olcLogLevel</div><div class="line"><span class="attribute">olcLogLevel</span>: 18432</div><div class="line"></div><div class="line">$ ldapmodify -Y EXTERNAL -H ldapi:/// -f log.ldif</div><div class="line"></div><div class="line">$ touch /var/log/ldap.log           <span class="comment"># 手动创建日志文件</span></div><div class="line">$ chown ldap:ldap /var/log/ldap.log  <span class="comment"># 记得更改权限</span></div><div class="line"></div><div class="line">$ echo "local4.* /var/log/lapd.log" &gt;&gt; /etc/rsyslog.conf    <span class="comment"># 设置rsyslog</span></div><div class="line">$ systemctl restart rsyslog</div></pre></td></tr></table></figure></p>
<hr>
<h4 id="OpenLDAP-双主同步配置"><a href="#OpenLDAP-双主同步配置" class="headerlink" title="OpenLDAP 双主同步配置"></a>OpenLDAP 双主同步配置</h4><h5 id="加载syncprov-la模块，并做简单的同步配置"><a href="#加载syncprov-la模块，并做简单的同步配置" class="headerlink" title="加载syncprov.la模块，并做简单的同步配置"></a>加载syncprov.la模块，并做简单的同步配置</h5><p><strong>要在每一个节点单独配置，且配置完全相同</strong></p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ vim mod_syncprov.ldif</div><div class="line"><span class="attribute">dn</span>: cn=module,cn=config</div><div class="line"><span class="attribute">objectClass</span>: olcModuleList</div><div class="line"><span class="attribute">cn</span>: module</div><div class="line"><span class="attribute">olcModulePath</span>: /usr/lib64/openldap</div><div class="line"><span class="attribute">olcModuleLoad</span>: syncprov.la</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f mod_syncprov.ldif</div><div class="line"></div><div class="line">$ vim syncprov.ldif</div><div class="line"><span class="attribute">dn</span>: olcOverlay=syncprov,olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">objectClass</span>: olcOverlayConfig</div><div class="line"><span class="attribute">objectClass</span>: olcSyncProvConfig</div><div class="line"><span class="attribute">olcOverlay</span>: syncprov</div><div class="line"><span class="attribute">olcSpSessionLog</span>: 100</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif</div></pre></td></tr></table></figure>
<h5 id="配置节点ID及其他节点地址"><a href="#配置节点ID及其他节点地址" class="headerlink" title="配置节点ID及其他节点地址"></a>配置节点ID及其他节点地址</h5><p>配置节点ID，不同节点的<code>olcServerID</code>值不能相同。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ vim mod_ServerId.ldif</div><div class="line"><span class="attribute">dn</span>: cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcServerID</div><div class="line"><span class="attribute">olcServerID</span>: 1</div><div class="line"></div><div class="line">$ ldapmodify -Y EXTERNAL -H ldapi:/// mod_ServerId.ldif</div></pre></td></tr></table></figure>
<p>配置另外一个的Master节点的连击信息，<code>olcSyncRepl</code>后面的值使用空格分割，等号两端不能有等号。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ vim master.ldif</div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcSyncRepl</div><div class="line"><span class="attribute">olcSyncRepl</span>: rid=001 provider=ldap://ldap*.example.com:389/ bindmethod=simple binddn="cn=admin,dc=example,dc=com" credentials=明文密码 searchbase="dc=example,dc=com" scope=sub schemachecking=on type=refreshAndPersist retry="5 5 300 +" attrs="*,+" interval=00:00:00:10</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f master.ldif</div><div class="line"></div><div class="line">$ vim masterMirrorMode.ldif</div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb,cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add</span>: olcMirrorMode</div><div class="line"><span class="attribute">olcMirrorMode</span>: TRUE</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// masterMirrorMode.ldif</div></pre></td></tr></table></figure>
<p>至此，如果不出意外，OpenLDAP的双机备份已经建好。</p>
<hr>
<h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><h3 id="0x00-Kerberos是个啥"><a href="#0x00-Kerberos是个啥" class="headerlink" title="0x00 Kerberos是个啥"></a>0x00 Kerberos是个啥</h3><blockquote>
<p>Kerberos是一种计算机网络授权协议，用来在非安全网络中，对个人通信以安全的手段进行身份认证。</p>
</blockquote>
<p>认证原理可以参考 <a href="https://blog.csdn.net/wulantian/article/details/42418231&quot;%3Ehttps://blog.csdn.net/wulantian/article/details/42418231" target="_blank" rel="external">https://blog.csdn.net/wulantian/article/details/42418231”>https://blog.csdn.net/wulantian/article/details/42418231</a></p>
<hr>
<h3 id="0x01-Kerberos安装及配置"><a href="#0x01-Kerberos安装及配置" class="headerlink" title="0x01 Kerberos安装及配置"></a>0x01 Kerberos安装及配置</h3><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p>比只配置使用默认数据库的Kerberos相比需要多安装<code>krb5-server-ldap</code> 提供kerberos对OpenLDAP数据库的支持。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y krb5-server krb5-workstation krb5-server-ldap</div></pre></td></tr></table></figure>
<h5 id="在OpenLDAP中添加对Kerberos的支持"><a href="#在OpenLDAP中添加对Kerberos的支持" class="headerlink" title="在OpenLDAP中添加对Kerberos的支持"></a>在OpenLDAP中添加对Kerberos的支持</h5><p>查找<code>kerberos.ldif</code>，并将<code>kerberos.ldif</code>和<code>kerberos.schema</code>复制到<code>/etc/openldap/schema/</code>目录下，并使用<code>ldapadd</code>加载<code>kerberos</code>相关的schema。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ find / -name kerberos.ldif  # 自己找一下</div><div class="line"></div><div class="line">$ ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/kerberod.ldif</div></pre></td></tr></table></figure>
<p><em>如果导入schema步骤出现问题，可以考虑下载源码编译后，找到对应文件再重新导入</em></p>
<h5 id="生成KDC用于访问LDAP的密码文件"><a href="#生成KDC用于访问LDAP的密码文件" class="headerlink" title="生成KDC用于访问LDAP的密码文件"></a>生成KDC用于访问LDAP的密码文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kdb5_ldap_util stashsrvpw -f /var/kerberos/krb5kdc/ldap.stash &quot;cn=admin,dc=example,dc=com&quot;</div></pre></td></tr></table></figure>
<h5 id="更改krb5配置文件"><a href="#更改krb5配置文件" class="headerlink" title="更改krb5配置文件"></a>更改krb5配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/krb5.conf</div><div class="line">[libdefaults]</div><div class="line"> default_realm = EXAMPLE.COM</div><div class="line"> dns_lookup_realm = false</div><div class="line"> dns_lookup_kdc = false</div><div class="line"> ticket_lifetime = 12h</div><div class="line"> renew_lifetime = 7d</div><div class="line"> forwardable = false</div><div class="line"></div><div class="line">[realms]</div><div class="line"> EXAMPLE.COM = &#123;</div><div class="line">  kdc = testkdc1.example.com:88</div><div class="line">  kdc = testkdc2.example.com:88</div><div class="line">  admin_server = testkadmin.example.com:749</div><div class="line">  default_domain = example.com</div><div class="line"> &#125;</div><div class="line"></div><div class="line">[domain_realm]</div><div class="line"> example.com = EXAMPLE.COM</div><div class="line"> .example.com = EXAMPLE.COM</div><div class="line"></div><div class="line">$ cat /var/kerberos/krb5kdc/kdc.conf</div><div class="line">[kdcdefaults]</div><div class="line"> kdc_ports = 88</div><div class="line"> kdc_tcp_ports = 88</div><div class="line"></div><div class="line">[realms]</div><div class="line"> EXAMPLE.COM = &#123;</div><div class="line">  kdc = testkdc1.example.com:88</div><div class="line">  kdc = testkdc2.example.com:88</div><div class="line">  admin_server = testkadmin.example.com:749</div><div class="line">  default_domain = example.com</div><div class="line">  database_module = openldap_ldapconf</div><div class="line">  # key_stash_file = /etc/krb5.EXAMPLE.COM</div><div class="line">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</div><div class="line">  supported_enctypes = aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</div><div class="line">&#125;</div><div class="line"></div><div class="line">[domain_realm]</div><div class="line"> example.com = EXAMPLE.COM</div><div class="line"> .example.com = EXAMPLE.COM</div><div class="line"></div><div class="line">[logging]</div><div class="line">    default = SYSLOG</div><div class="line">    admin_server = FILE:/var/log/kadmind.log</div><div class="line">    kdc = FILE:/var/log/kdc.log</div><div class="line"></div><div class="line">[dbdefaults]</div><div class="line">    ldap_kerberos_container_dn = cn=admin,dc=example,dc=com</div><div class="line"></div><div class="line">[dbmodules]</div><div class="line">    openldap_ldapconf = &#123;</div><div class="line">        db_library = kldap</div><div class="line">        ldap_servers = ldap://ldap.example.com</div><div class="line">        ldap_kerberos_container_dn = cn=admin,dc=example,dc=com</div><div class="line">        ldap_kdc_dn = cn=admin,dc=example,dc=com</div><div class="line">        ldap_kadmind_dn = cn=admin,dc=example,dc=com</div><div class="line">        ldap_service_password_file = /var/kerberos/krb5kdc/ldap.stash</div><div class="line">        ldap_conns_per_server = 5</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="在LDAP中初始化KDC数据库"><a href="#在LDAP中初始化KDC数据库" class="headerlink" title="在LDAP中初始化KDC数据库"></a>在LDAP中初始化KDC数据库</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kdb5_ldap_util -D cn=admin,dc=example,dc=com -W -H ldap://ldap.example.com create -r EXAMPLE.COM -s</div></pre></td></tr></table></figure>
<p>如果已有线上正在运行的KDC服务后续需要导入数据，建议Master Key设置为与线上相同，导入数据后再进行更改。<br>或者可以手动替换<code>key_stash_file</code>，默认位于<code>/var/kerberos/krb5kdc/.K5.REALMS.NAME</code>的一个隐藏文件</p>
<p>第六步、启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl start krb5kdc kadmin</div></pre></td></tr></table></figure>
<hr>
<h2 id="数据备份及还原"><a href="#数据备份及还原" class="headerlink" title="数据备份及还原"></a>数据备份及还原</h2><blockquote>
<p>备份还原与正常方式相同，从默认数据库迁移到LDAP还是很方便的（除了时间问题）。<br>备份一瞬间，恢复一下午。充分展示了LDAP的读写性能差异。 </p>
</blockquote>
<h3 id="0x01-原KDC数据备份"><a href="#0x01-原KDC数据备份" class="headerlink" title="0x01 原KDC数据备份"></a>0x01 原KDC数据备份</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kdb5_util dump -verberos /tmp/KDCdumpfile</div></pre></td></tr></table></figure>
<h3 id="0x02-导入新KDC"><a href="#0x02-导入新KDC" class="headerlink" title="0x02 导入新KDC"></a>0x02 导入新KDC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$  kdb5_util load -update -verbose /tmp/KDCdumpfile</div></pre></td></tr></table></figure>
<hr>
<h2 id="细节、性能、坑"><a href="#细节、性能、坑" class="headerlink" title="细节、性能、坑"></a>细节、性能、坑</h2><h3 id="0x01-OpenLDAP索引"><a href="#0x01-OpenLDAP索引" class="headerlink" title="0x01 OpenLDAP索引"></a>0x01 OpenLDAP索引</h3><h4 id="为何要创建索引"><a href="#为何要创建索引" class="headerlink" title="为何要创建索引"></a>为何要创建索引</h4><p>无索引情况下，日志中出现大量的<code>krbPrincipalName not index</code> 的报错信息，少量的<code>uid not index</code> 的报错信息，且CPU占用大幅增加。直接导致查询认证过程变慢，可用性降低。</p>
<h4 id="如何创建索引创建哪个索引"><a href="#如何创建索引创建哪个索引" class="headerlink" title="如何创建索引创建哪个索引"></a>如何创建索引创建哪个索引</h4><p>秉承的缺啥补啥的原则，为krbPrincipalName，uid创建索引。</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ vim hdb-index.ldif</div><div class="line"><span class="attribute">dn</span>: olcDatabase=&#123;2&#125;hdb, cn=config</div><div class="line"><span class="attribute">changetype</span>: modify</div><div class="line"><span class="attribute">add:olcDbIndex</span></div><div class="line">olcDbIndex: krbPrincipalName,uid pres,eq,sub</div><div class="line"></div><div class="line">$ ldapmodify -Y EXTERNAL -H ldapi:/// hdb-index.ldif</div></pre></td></tr></table></figure>
<h3 id="0x02-KDC密码策略"><a href="#0x02-KDC密码策略" class="headerlink" title="0x02 KDC密码策略"></a>0x02 KDC密码策略</h3><h4 id="创建及使用密码策略"><a href="#创建及使用密码策略" class="headerlink" title="创建及使用密码策略"></a>创建及使用密码策略</h4><p>设置方式参考<a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/admin_commands/kadmin_local.html#add-policy" target="_blank" rel="external">Kadmin文档</a>，建议基础密码策略为：8位-90天-3种字符。</p>
<h4 id="半路出家的坏处"><a href="#半路出家的坏处" class="headerlink" title="半路出家的坏处"></a>半路出家的坏处</h4><p>下面是一些中途添加密码策略的坑点，建议使用初期就配置密码策略，避免不必要麻烦。</p>
<ul>
<li>无密码策略时，密码过期时间为None</li>
<li>注意2038年问题，密码最大生命周期不能盲目填大</li>
<li>为用户添加密码了略后，密码过期时间立即变更，<strong>会与手动指定的密码过期时间中较早的一个生效</strong></li>
<li>使用OpenLDAP作为数据库的时候，并不支持历史密码存储，所以密码策略配置了与历史密码不同的次数也不会生效。</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-05-04</span><i class="fa fa-tag"></i><a href="/tags/安全运维/" title="安全运维" class="tag">安全运维 </a><a href="/tags/Kerberos/" title="Kerberos" class="tag">Kerberos </a><a href="/tags/Ldap/" title="Ldap" class="tag">Ldap </a></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://hthuanchen.github.io/2019/05/04/Kerberos-OpenLDAP配置及坑点/,幻辰,Kerberos-OpenLDAP配置及坑点,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2019/04/27/hello-world/" title="Hello World" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>